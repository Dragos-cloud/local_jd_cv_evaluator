name: ğŸ” Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-validate:
    name: ğŸ§¹ Lint & Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        npm install -g htmlhint stylelint eslint
        
    - name: ğŸ” Lint HTML
      run: |
        htmlhint --config .htmlhintrc standalone_cv_jd_evaluator.html || echo "HTML linting completed with warnings"
        
    - name: ğŸ¨ Lint CSS (extract from HTML)
      run: |
        # Extract CSS from HTML for linting
        sed -n '/<style>/,/<\/style>/p' standalone_cv_jd_evaluator.html | sed '1d;$d' > temp-styles.css
        if [ -s temp-styles.css ]; then
          stylelint temp-styles.css --config-basedir . || echo "CSS linting completed with warnings"
        fi
        rm -f temp-styles.css
        
    - name: ğŸ” Lint JavaScript (extract from HTML)
      run: |
        # Extract JavaScript from HTML for linting
        sed -n '/<script>/,/<\/script>/p' standalone_cv_jd_evaluator.html | sed '1d;$d' > temp-script.js
        if [ -s temp-script.js ]; then
          eslint temp-script.js --no-eslintrc --env browser,es6 --parserOptions ecmaVersion:2020 || echo "JavaScript linting completed with warnings"
        fi
        rm -f temp-script.js

  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run security scan
      run: |
        # Check for common security issues in HTML/JS
        echo "ğŸ” Checking for potential security issues..."
        
        # Check for eval usage
        if grep -n "eval(" standalone_cv_jd_evaluator.html; then
          echo "âš ï¸  Warning: Found eval() usage - review for security"
        fi
        
        # Check for innerHTML with user input
        if grep -n "innerHTML.*input\|innerHTML.*value" standalone_cv_jd_evaluator.html; then
          echo "âš ï¸  Warning: Potential XSS risk with innerHTML - verify sanitization"
        fi
        
        # Check for external script sources
        if grep -n "src=[\"']http" standalone_cv_jd_evaluator.html; then
          echo "â„¹ï¸  External resources found - verify they are necessary and secure"
        fi
        
        echo "âœ… Security scan completed"

  validate-structure:
    name: ğŸ“‹ Validate Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate HTML structure
      run: |
        echo "ğŸ” Validating HTML structure..."
        
        # Check for required sections
        required_sections=("header" "main" "footer" "LM Studio Configuration" "Input Section" "Analysis Options")
        
        for section in "${required_sections[@]}"; do
          if ! grep -q "$section" standalone_cv_jd_evaluator.html; then
            echo "âŒ Missing required section: $section"
            exit 1
          else
            echo "âœ… Found section: $section"
          fi
        done
        
        # Check for required functionality
        required_functions=("CVJobMatcherStandalone" "analyzeText" "exportText" "testLMStudioConnection")
        
        for func in "${required_functions[@]}"; do
          if ! grep -q "$func" standalone_cv_jd_evaluator.html; then
            echo "âŒ Missing required function: $func"
            exit 1
          else
            echo "âœ… Found function: $func"
          fi
        done
        
        echo "âœ… HTML structure validation completed"

  test-file-integrity:
    name: ğŸ§ª Test File Integrity
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ§ª Test file can be loaded
      run: |
        echo "ğŸ§ª Testing file integrity..."
        
        # Check if file exists and is readable
        if [ ! -f "standalone_cv_jd_evaluator.html" ]; then
          echo "âŒ Main HTML file not found"
          exit 1
        fi
        
        # Check file size (should be reasonable)
        file_size=$(wc -c < standalone_cv_jd_evaluator.html)
        echo "ğŸ“ File size: $file_size bytes"
        
        if [ "$file_size" -lt 10000 ]; then
          echo "âŒ File seems too small"
          exit 1
        fi
        
        if [ "$file_size" -gt 5000000 ]; then
          echo "âš ï¸  Warning: File is quite large (>5MB)"
        fi
        
        # Test basic HTML validity
        if ! grep -q "<!DOCTYPE html>" standalone_cv_jd_evaluator.html; then
          echo "âŒ Missing DOCTYPE declaration"
          exit 1
        fi
        
        if ! grep -q "<html" standalone_cv_jd_evaluator.html; then
          echo "âŒ Missing HTML tag"
          exit 1
        fi
        
        if ! grep -q "</html>" standalone_cv_jd_evaluator.html; then
          echo "âŒ Missing closing HTML tag"
          exit 1
        fi
        
        echo "âœ… File integrity test passed"

  check-dependencies:
    name: ğŸ“¦ Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Check external dependencies
      run: |
        echo "ğŸ” Checking external dependencies..."
        
        # Extract all external URLs
        external_urls=$(grep -o 'https\?://[^"'\'' ]*' standalone_cv_jd_evaluator.html || true)
        
        if [ -z "$external_urls" ]; then
          echo "âœ… No external dependencies found"
        else
          echo "ğŸ“¦ External dependencies found:"
          echo "$external_urls"
          
          # Test if external resources are accessible
          for url in $external_urls; do
            echo "ğŸ” Testing: $url"
            if curl -s --head "$url" | grep "200 OK" > /dev/null; then
              echo "âœ… $url - OK"
            else
              echo "âš ï¸  $url - May not be accessible"
            fi
          done
        fi

  documentation-check:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Check documentation completeness
      run: |
        echo "ğŸ” Checking documentation..."
        
        required_files=("README.md" "LICENSE" "CONTRIBUTING.md" ".gitignore")
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        
        # Check README sections
        readme_sections=("Features" "Setup" "Usage" "Privacy" "Contributing")
        
        for section in "${readme_sections[@]}"; do
          if ! grep -qi "$section" README.md; then
            echo "âš ï¸  README may be missing section: $section"
          else
            echo "âœ… README contains: $section"
          fi
        done
        
        echo "âœ… Documentation check completed"